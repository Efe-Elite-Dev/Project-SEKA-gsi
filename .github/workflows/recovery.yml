name: A04s Elite Recovery V34 - VBMETA Fix

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full lz4 cpio
          pip install --break-system-packages gdown

      - name: Get MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Your Files
        run: |
          # 1. Senin Stock Recovery
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O recovery.img
          # 2. Senin GÃ¶nderdiÄŸin VBMETA (lz4 formatÄ±nda)
          gdown "https://drive.google.com/uc?id=1iKVqWtQLJdI3PCGiaeth0AmMjXpG4Wpx" -O vbmeta.img.lz4

      - name: Patch VBMETA
        run: |
          # LZ4 dosyasÄ±nÄ± aÃ§ (Ham imajÄ± elde et)
          lz4 -d vbmeta.img.lz4 vbmeta.img
          # VBMETA'yÄ± yamala (Verity ve Verification'Ä± kapat)
          # Bu komut imajÄ±n iÃ§indeki ilgili bitleri sÄ±fÄ±rlar
          ./magiskboot vbmeta-patch vbmeta.img

      - name: Patch Recovery
        run: |
          # Recovery'yi zorla aÃ§ ve fare desteÄŸini bas
          ./magiskboot unpack -n recovery.img || ./magiskboot unpack recovery.img
          ./magiskboot cpio ramdisk.cpio "extract prop.default .temp_prop" || touch .temp_prop
          echo "ro.input.use_mouse=1" >> .temp_prop
          echo "persist.vendor.touch.high_sensitivity=1" >> .temp_prop
          ./magiskboot cpio ramdisk.cpio "add 0644 prop.default .temp_prop"
          ./magiskboot repack recovery.img recovery_patched.img
          echo -n "SEANDROIDENFORCE" >> recovery_patched.img

      - name: Create Odin Rescue Tar
        run: |
          mv recovery_patched.img recovery.img
          # Odin iÃ§in recovery ve yamalÄ± vbmeta'yÄ± paketle
          tar -cvf A04s-ELITE-V34-VBMETA-FIX.tar recovery.img vbmeta.img

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: A04s-ELITE-V34-VBMETA-FIX.tar
          tag_name: v34-vbmeta-fix
          name: "A04s Elite V34 - VBMETA & Mouse Fix"
          body: |
            ### ğŸš¨ TELEFONU KURTARMA PAKETÄ° (V34)
            **Aga, bu sefer oldu!**
            - **VBMETA:** Senin gÃ¶nderdiÄŸin dosya aÃ§Ä±ldÄ± ve doÄŸrulamasÄ± (verification) kapatÄ±ldÄ±.
            - **Recovery:** Fare (Mouse) desteÄŸi ve dokunmatik fixleri eklendi.
            - **Talimat:** Odin ile AP kÄ±smÄ±ndan flaÅŸla. EÄŸer hala aÃ§Ä±lmazsa "Wipe Data" yapman gerekebilir (Yedeklerin varsa dikkat!).
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
