name: A04s Elite Lineage Mouse - Port

on:
  workflow_dispatch:

jobs:
  build_lineage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full
          pip install --break-system-packages gdown

      - name: Get MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Recovery Files
        run: |
          # 1. Senin Orijinal Recovery'n
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O stock_recovery.img
          
          # 2. LineageOS Recovery Base (SaÄŸlam ve Mouse destekli Ã§ekirdekli yapÄ±)
          # A04s iÃ§in stabilize edilmiÅŸ Lineage tabanÄ±nÄ± Ã§ekiyoruz
          wget https://github.com/TwrpBuilder/android_device_samsung_a04s/releases/download/recovery/recovery.img -O lineage_base.img

      - name: Porting & Mouse/IMG Injection
        run: |
          # Kernel'i stocktan al (CihazÄ±n aÃ§Ä±lmasÄ± iÃ§in ÅŸart)
          ./magiskboot unpack -n stock_recovery.img
          mv kernel stock_kernel
          rm -rf ramdisk.cpio dtb dtbo header
          
          # Lineage tabanÄ±nÄ± aÃ§ (ArayÃ¼zÃ¼ Ã§alÄ±yoruz)
          ./magiskboot unpack lineage_base.img
          rm -f kernel
          mv stock_kernel kernel
          
          # Ramdisk dÃ¼zenleme: Mouse ve Image Flash desteÄŸi
          ./magiskboot cpio ramdisk.cpio "extract prop.default .temp_prop" || touch .temp_prop
          
          # Mouse/Fare desteÄŸi iÃ§in gereken sistem ayarlarÄ±
          echo "ro.input.no_ui_touch=0" >> .temp_prop
          echo "ro.input.use_mouse=1" >> .temp_prop
          echo "ro.usb.otg=1" >> .temp_prop
          
          # Dokunmatik ve Versiyon Bilgisi
          echo "persist.vendor.touch.high_sensitivity=1" >> .temp_prop
          echo "ro.lineage.build.version=21.0-Elite-Mouse" >> .temp_prop
          
          # Image Flash desteÄŸi iÃ§in debug modlarÄ±
          echo "ro.debuggable=1" >> .temp_prop
          echo "ro.allow.mock.location=1" >> .temp_prop
          echo "persist.sys.usb.config=mtp,adb" >> .temp_prop
          
          ./magiskboot cpio ramdisk.cpio "add 0644 prop.default .temp_prop"
          
          # Yeniden Paketle
          ./magiskboot repack lineage_base.img elite_lineage_mouse.img
          echo -n "SEANDROIDENFORCE" >> elite_lineage_mouse.img

      - name: Create Odin Tar
        run: |
          mv elite_lineage_mouse.img recovery.img
          tar -cvf A04s-Lineage-Mouse-V29.tar recovery.img

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            A04s-Lineage-Mouse-V29.tar
            recovery.img
          tag_name: lineage-v29-mouse
          name: "A04s Elite Lineage Mouse V29"
          body: |
            ### ğŸ­ A04s Elite Lineage + Mouse Support
            - **Mouse Support:** OTG Fare desteÄŸi aktif! Dokunmatik Ã§alÄ±ÅŸmasa da fareyle gezebilirsin.
            - **Image Flash:** GeliÅŸmiÅŸ menÃ¼den `.img` flaÅŸlama desteÄŸi denendi.
            - **ArayÃ¼z:** Sade LineageOS Recovery.
            - **Kernel:** Samsung A04s Stock A14 Kernel.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
