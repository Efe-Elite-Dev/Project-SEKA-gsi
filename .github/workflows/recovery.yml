name: A04s Elite Recovery V37 - Manual Fix

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full lz4 cpio
          pip install --break-system-packages gdown

      - name: Get MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Files
        run: |
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O recovery.img
          gdown "https://drive.google.com/uc?id=1iKVqWtQLJdI3PCGiaeth0AmMjXpG4Wpx" -O vbmeta.img.lz4

      - name: Patch VBMETA
        run: |
          lz4 -d vbmeta.img.lz4 vbmeta.img
          python3 -c "with open('vbmeta.img', 'rb+') as f: f.seek(123); f.write(b'\x03')"

      - name: Manual Ramdisk Surgery
        run: |
          # 1. ParÃ§ala
          ./magiskboot unpack -n recovery.img
          
          # 2. Ramdisk'i manuel olarak LZ4'ten CPIO'ya Ã§evir
          # Samsung ramdiskleri genelde lz4_legacy veya standart lz4 olur
          lz4 -d ramdisk.cpio ramdisk_raw.cpio || cp ramdisk.cpio ramdisk_raw.cpio
          
          # 3. KlasÃ¶r aÃ§ ve iÃ§ine Ã§Ä±kart
          mkdir rd
          cd rd
          cpio -id < ../ramdisk_raw.cpio || echo "CPIO extract hatasÄ±, ama devam et"
          
          # 4. AyarlarÄ± bas
          TARGET_PROP=$(find . -name "prop.default" -o -name "default.prop" | head -n 1)
          if [ -z "$TARGET_PROP" ]; then TARGET_PROP="prop.default"; touch "$TARGET_PROP"; fi
          echo "ro.input.use_mouse=1" >> "$TARGET_PROP"
          echo "persist.vendor.touch.high_sensitivity=1" >> "$TARGET_PROP"
          
          # 5. Geri Paketle (GZIP olarak, Ã§Ã¼nkÃ¼ header'da RAMDISK_FMT [gzip] yazÄ±yor!)
          find . | cpio -H newc -o | gzip > ../ramdisk.cpio
          cd ..
          
          # 6. MagiskBoot ile Repack
          ./magiskboot repack recovery.img recovery_fixed.img
          echo -n "SEANDROIDENFORCE" >> recovery_fixed.img

      - name: Create Odin Tar
        run: |
          mv recovery_fixed.img recovery.img
          tar -cvf A04s-V37-MANUAL-RESCUE.tar recovery.img vbmeta.img

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: A04s-V37-MANUAL-RESCUE.tar
          tag_name: v37-manual
          name: "A04s Elite V37 - Manual Rescue"
          body: |
            ### ðŸš¨ MANUEL RAMDISK AMELÄ°YATI (V37)
            - **Bypass:** `invalid cpio magic` hatasÄ± manuel decompress ile aÅŸÄ±ldÄ±.
            - **VBMETA:** YamalÄ±, doÄŸrulamalar kapalÄ±.
            - **Durum:** 28 Ocak'Ä±n son mermisi!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
