name: A04s Elite TWRP - Port

on:
  workflow_dispatch:

jobs:
  build_twrp:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full
          pip install --break-system-packages gdown

      - name: Get Official MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Files
        run: |
          # 1. Senin Orijinal Recovery'n (Kernel kaynaÄŸÄ±)
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O stock_recovery.img
          
          # 2. A04s TWRP TabanÄ± (ArayÃ¼z kaynaÄŸÄ±)
          # Bu link SM-A047F iÃ§in portlanmÄ±ÅŸ bir TWRP tabanÄ±dÄ±r
          wget https://github.com/GiaSen/Recovery_Port_A12/releases/download/v1/TWRP_3.6.0_A12_Port.img -O twrp_base.img || echo "Base indirilemedi!"

      - name: Porting Process
        run: |
          # Orijinal kernelini Ã§Ä±kar
          ./magiskboot unpack stock_recovery.img
          mv kernel stock_kernel
          ./magiskboot cleanup
          
          # TWRP tabanÄ±nÄ± parÃ§ala
          ./magiskboot unpack twrp_base.img
          
          # TWRP'nin ramdisk'ine (arayÃ¼zÃ¼ne) senin kernelini tak
          rm -f kernel
          mv stock_kernel kernel
          
          # Elite YamalarÄ± (Dokunmatik hassasiyeti)
          ./magiskboot cpio ramdisk.cpio "extract prop.default .temp_prop" || touch .temp_prop
          echo "persist.vendor.touch.high_sensitivity=1" >> .temp_prop
          echo "ro.input.resampling=1" >> .temp_prop
          ./magiskboot cpio ramdisk.cpio "add 0644 prop.default .temp_prop"
          
          # Yeni TWRP'yi topla
          ./magiskboot repack twrp_base.img elite_twrp.img

      - name: Create Odin Package
        run: |
          mv elite_twrp.img recovery.img
          tar -cvf A04s-Elite-TWRP-V28.tar recovery.img
          sha256sum recovery.img > sha256.txt

      - name: Release TWRP
        uses: softprops/action-gh-release@v1
        with:
          files: |
            A04s-Elite-TWRP-V28.tar
            recovery.img
          tag_name: twrp-v28-ported
          name: "A04s Elite TWRP V28 - Ported Interface"
          body: |
            ### ðŸŽ¹ A04s Elite TWRP (VocaloidWorld1)
            - **ArayÃ¼z:** TWRP (Install/Wipe butonlarÄ± aktif!)
            - **Kernel:** Senin Stock Kernelin (AÃ§Ä±lÄ±ÅŸ garantili).
            - **Fix:** Touch Boost ve High Sensitivity eklendi.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
