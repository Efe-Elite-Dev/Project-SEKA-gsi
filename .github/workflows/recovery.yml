name: A04s Elite Recovery V35 - VBMETA Fix

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full lz4 cpio
          pip install --break-system-packages gdown

      - name: Get MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Your Files
        run: |
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O recovery.img
          gdown "https://drive.google.com/uc?id=1iKVqWtQLJdI3PCGiaeth0AmMjXpG4Wpx" -O vbmeta.img.lz4

      - name: Manual VBMETA Patch (Python)
        run: |
          # LZ4 dosyasÄ±nÄ± aÃ§
          lz4 -d vbmeta.img.lz4 vbmeta.img
          
          # VBMETA doÄŸrulamasÄ±nÄ± kapatan Python scripti
          # Flags kÄ±smÄ±nÄ± (offset 123) 0x03 yaparak disable_verity ve disable_verification ekliyoruz
          python3 -c "
          with open('vbmeta.img', 'rb+') as f:
              f.seek(123)
              f.write(b'\x03')
          "
          echo "VBMETA manuel olarak yamalandÄ± (Flags: 0x03)"

      - name: Patch Recovery
        run: |
          # Recovery'yi zorla aÃ§ ve fare desteÄŸini bas
          ./magiskboot unpack -n recovery.img || ./magiskboot unpack recovery.img
          ./magiskboot cpio ramdisk.cpio "extract prop.default .temp_prop" || touch .temp_prop
          echo "ro.input.use_mouse=1" >> .temp_prop
          echo "persist.vendor.touch.high_sensitivity=1" >> .temp_prop
          ./magiskboot cpio ramdisk.cpio "add 0644 prop.default .temp_prop"
          ./magiskboot repack recovery.img recovery_patched.img
          echo -n "SEANDROIDENFORCE" >> recovery_patched.img

      - name: Create Odin Rescue Tar
        run: |
          mv recovery_patched.img recovery.img
          tar -cvf A04s-ELITE-V35-RESCUE.tar recovery.img vbmeta.img

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: A04s-ELITE-V35-RESCUE.tar
          tag_name: v35-vbmeta-manual
          name: "A04s Elite V35 - VBMETA Manual Fix"
          body: |
            ### ðŸš¨ KURTARMA PAKETÄ° V35
            **Aga, bu sefer hata payÄ± yok!**
            - **VBMETA:** Python ile manuel olarak yamalandÄ± (Flags: 0x03). 
            - **Recovery:** Mouse desteÄŸi eklendi.
            - **Odin:** AP kÄ±smÄ±na koy ve flaÅŸla.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
