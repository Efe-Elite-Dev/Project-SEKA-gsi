name: A04s Elite Recovery - V33 Manual

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full lz4 cpio
          pip install --break-system-packages gdown

      - name: Get MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Stock Recovery
        run: |
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O recovery.img

      - name: Manual Ramdisk Patching
        run: |
          # 1. Ä°majÄ± parÃ§ala (ASN.1 hatasÄ±nÄ± salla, kernel ve ramdisk.cpio Ã§Ä±kacak)
          ./magiskboot unpack -n recovery.img || ./magiskboot unpack recovery.img
          
          # 2. Ramdisk'i manuel aÃ§mayÄ± dene (LZ4 veya GZIP)
          mkdir ramdisk_dir
          cd ramdisk_dir
          # Ramdisk'i manuel olarak Ã§Ä±kartÄ±yoruz
          lz4 -d ../ramdisk.cpio -c | cpio -idm || zcat ../ramdisk.cpio | cpio -idm || cpio -idm < ../ramdisk.cpio || echo "Manuel aÃ§ma baÅŸarÄ±sÄ±z!"
          
          # 3. Elite AyarlarÄ±nÄ± Enjekte Et (prop.default veya default.prop)
          TARGET_PROP=$(find . -name "prop.default" -o -name "default.prop" | head -n 1)
          if [ -f "$TARGET_PROP" ]; then
            echo "Aga prop dosyasÄ± bulundu: $TARGET_PROP"
            echo "ro.input.use_mouse=1" >> "$TARGET_PROP"
            echo "persist.vendor.touch.high_sensitivity=1" >> "$TARGET_PROP"
            echo "ro.usb.otg=1" >> "$TARGET_PROP"
            echo "ro.debuggable=1" >> "$TARGET_PROP"
          else
            echo "ro.input.use_mouse=1" >> prop.default
          fi
          
          # 4. Ramdisk'i geri topla (GZIP formatÄ±nda)
          find . | cpio -H newc -o | gzip > ../ramdisk_new.cpio
          cd ..
          
          # 5. MagiskBoot ile ramdisk'i deÄŸiÅŸtir ve topla
          mv ramdisk_new.cpio ramdisk.cpio
          ./magiskboot repack recovery.img recovery_new.img
          echo -n "SEANDROIDENFORCE" >> recovery_new.img

      - name: Create Odin Tar
        run: |
          mv recovery_new.img recovery.img
          tar -cvf A04s-Elite-V33-Manual.tar recovery.img

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            A04s-Elite-V33-Manual.tar
            recovery.img
          tag_name: v33-manual
          name: "A04s Elite Recovery V33 - Manual Patch"
          body: |
            ### ðŸŽ¹ A04s Elite V33 (Manual Decompress)
            - **Fix:** MagiskBoot'un aÃ§amadÄ±ÄŸÄ± cpio manuel olarak `lz4/gzip` ile aÃ§Ä±ldÄ±.
            - **Mouse:** Fare ve OTG desteÄŸi kodlarÄ± enjekte edildi.
            - **Odin:** Samsung A04s A14 uyumlu.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
