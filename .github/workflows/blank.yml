name: GSI Ultimate Tıkır Tıkır (D2TW + Touch Fix + BuildProp)

on:
  workflow_dispatch:

jobs:
  mod-gsi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # En güncel checkout sürümü

      - name: Install System Tools
        run: |
          sudo apt-get update
          # Ubuntu 24.04 için doğru paket bu:
          sudo apt-get install -y android-sdk-libsparse-utils
          
          # Komutları standart isimlere (simg2img/img2simg) bağlayalım
          sudo ln -sf /usr/bin/android-simg2img /usr/local/bin/simg2img
          sudo ln -sf /usr/bin/android-img2simg /usr/local/bin/img2simg

      - name: Mount and Inject Mods
        run: |
          # 1. Hazırlık: Sparse imajı ham (raw) imaja çevir
          # Eğer dosya zaten raw ise kopyalar, hata vermez
          simg2img miku.img miku_raw.img || cp miku.img miku_raw.img
          
          mkdir sys_mount
          # Loopback ile mount et
          sudo mount -o loop miku_raw.img sys_mount
          
          # --- 2. D2TW & Ekran Hassasiyeti (build.prop Modları) ---
          cat <<EOF | sudo tee -a sys_mount/system/build.prop
          # Project-SEKA-gsi Elite Configs
          persist.sys.phh.d2tw=true
          ro.vendor.sdk.gesture.d2tw=1
          persist.vendor.qti.input_resampling_rate=120
          view.touch_slop=2
          view.scroll_friction=0.008
          ro.config.hw_quickpoweron=true
          EOF
          
          # --- 3. Touch Fix Script (Topluluk İstedi, Biz Yaptık) ---
          # services.sh dosyanın ana dizinde olduğunu varsayıyorum
          sudo cp services.sh sys_mount/system/bin/gsi-touch-fix.sh
          sudo chmod 755 sys_mount/system/bin/gsi-touch-fix.sh
          
          # --- 4. Init Service (Scripti Otomatik Başlatma) ---
          cat <<EOF | sudo tee sys_mount/system/etc/init/gsi_fixes.rc
          service gsi_fixes /system/bin/sh /system/bin/gsi-touch-fix.sh
              class main
              user root
              group root
              oneshot
          EOF
          
          # --- 5. Volume Wake (Ses Tuşlarıyla Uyandırma) ---
          # 115: Ses Açma, 114: Ses Kısma
          sudo sed -i 's/key 115   VOLUME_UP/key 115   VOLUME_UP           WAKE/g' sys_mount/system/usr/keylayout/Generic.kl
          sudo sed -i 's/key 114   VOLUME_DOWN/key 114   VOLUME_DOWN         WAKE/g' sys_mount/system/usr/keylayout/Generic.kl

          # 6. Kapatma ve Geri Paketleme
          sudo umount sys_mount
          img2simg miku_raw.img miku_final.img

      - name: Upload Modified GSI
        uses: actions/upload-artifact@v4
        with:
          name: Miku-GSI-Tikir-Tikir-Edition
          path: miku_final.img
