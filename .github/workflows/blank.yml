name: GSI Ultimate (Release Edition)

on:
  workflow_dispatch:

jobs:
  mod-gsi:
    runs-on: ubuntu-latest
    permissions: # Release olu≈üturmak i√ßin yetki lazƒ±m
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y android-sdk-libsparse-utils python3-pip
          pip3 install gdown --break-system-packages
          sudo ln -sf /usr/bin/android-simg2img /usr/local/bin/simg2img
          sudo ln -sf /usr/bin/android-img2simg /usr/local/bin/img2simg

      - name: Download GSI
        run: gdown --id 1A8sLEoItqNuoX1LnWJUKokZRPtHter_k -O miku.img

      - name: Mount and Inject Mods
        run: |
          simg2img miku.img miku_raw.img || cp miku.img miku_raw.img
          mkdir sys_mount
          sudo mount -o loop miku_raw.img sys_mount
          
          # 1. build.prop (D2TW & Touch)
          cat <<EOF | sudo tee -a sys_mount/system/build.prop
          persist.sys.phh.d2tw=true
          ro.vendor.sdk.gesture.d2tw=1
          persist.vendor.qti.input_resampling_rate=120
          view.touch_slop=2
          ro.config.hw_quickpoweron=true
          EOF
          
          # 2. Touch Fix Script
          cat <<EOF | sudo tee sys_mount/system/bin/gsi-touch-fix.sh
          #!/system/bin/sh
          fix() { su -c 'echo check_connection > /sys/class/sec/tsp/cmd && cat /sys/class/sec/tsp/cmd_result';}
          dir="/sys/class/backlight/panel/brightness"
          while true; do
            sleep .6
            new=\$(cat "\$dir")
            [ "\$old" != "\$new" ] && [ "\$new" != "0" ] && fix
            old=\$new
          done
          EOF
          sudo chmod 755 sys_mount/system/bin/gsi-touch-fix.sh
          
          # 3. Init Service
          cat <<EOF | sudo tee sys_mount/system/etc/init/gsi_fixes.rc
          service gsi_fixes /system/bin/sh /system/bin/gsi-touch-fix.sh
              class main
              user root
              group root
              oneshot
          EOF
          
          # 4. Volume Wake
          sudo sed -i 's/key 115   VOLUME_UP/key 115   VOLUME_UP           WAKE/g' sys_mount/system/usr/keylayout/Generic.kl
          sudo sed -i 's/key 114   VOLUME_DOWN/key 114   VOLUME_DOWN         WAKE/g' sys_mount/system/usr/keylayout/Generic.kl

          sudo umount sys_mount
          img2simg miku_raw.img miku_final.img

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}-${{ github.sha }}" # Her seferinde deƒüi≈üen versiyon
          name: "Project-SEKA GSI Build ${{ github.run_number }}"
          body: |
            ### üÖ• Vocaloid World Special Edition
            - **Touch Fix:** Ekran kapalƒ±yken dokunmatik sorunu √ß√∂z√ºld√º.
            - **D2TW:** √áift tƒ±kla uyandƒ±rma aktif.
            - **Volume Wake:** Ses tu≈ülarƒ±yla uyandƒ±rma eklendi.
            - **Build Date:** $(date +'%Y-%m-%d %H:%M')
          files: miku_final.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
