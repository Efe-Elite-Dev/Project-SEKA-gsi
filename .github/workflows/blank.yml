- name: Deep Integration (Ext4 Specialist)
        run: |
          # Sparse dosyaları Raw'a çevirmeyi tekrar, daha güçlü dene
          # Eğer dosya zaten raw ise hata verse de kopyalayıp devam edecek
          img2simg miku.img miku_sparse.img || cp miku.img miku_sparse.img
          simg2img miku_sparse.img miku_raw.img || cp miku.img miku_raw.img
          
          simg2img vendor.img vendor_raw.img || cp vendor.img vendor_raw.img
          
          mkdir mnt_miku mnt_vendor
          
          # EXT4 olduğunu bildiğimiz için zorlayarak mount ediyoruz
          # 'noload' seçeneği bozuk superblock hatalarını bypass eder
          sudo mount -t ext4 -o loop,rw,noload miku_raw.img mnt_miku || sudo mount -o loop,rw miku_raw.img mnt_miku
          sudo mount -t ext4 -o loop,ro,noload vendor_raw.img mnt_vendor || sudo mount -o loop,ro vendor_raw.img mnt_vendor
          
          # Vendor Entegrasyonu
          # Eğer mount başarılı olduysa klasörleri birleştir
          if [ -d "mnt_miku/system" ]; then
            sudo rm -rf mnt_miku/system/vendor/*
            sudo cp -rv mnt_vendor/* mnt_miku/system/vendor/
            
            # PJSK FPS ve Dokunmatik Modu
            sudo bash -c "echo 'persist.sys.composition.type=gpu' >> mnt_miku/system/build.prop"
            sudo bash -c "echo 'debug.performance.tuning=1' >> mnt_miku/system/build.prop"
          else
            echo "Aga hala mount edemedik, dosya sistemi çok inatçı!"
            exit 1
          fi
          
          sudo umount -l mnt_miku
          sudo umount -l mnt_vendor
          
          # Final dosyasını Sparse formatına geri çevir (Telefona flaşlamak için daha güvenli)
          img2simg miku_raw.img A04s_Miku_AllInOne.img
