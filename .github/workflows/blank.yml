name: GSI Ultimate Tıkır Tıkır (D2TW + Touch Fix + BuildProp)

on:
  workflow_dispatch:

jobs:
  mod-gsi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y simg2img img2simg android-sdk-libsparse-utils

      - name: Mount and Inject Mods
        run: |
          # miku.img dosyasını hazırlıyoruz
          simg2img miku.img miku_raw.img || mv miku.img miku_raw.img
          mkdir sys_mount
          sudo mount -o loop miku_raw.img sys_mount
          
          # --- 1. D2TW & Ekran Hassasiyeti (build.prop Modları) ---
          # Bunlar dokunmatik panelin tepki süresini mermi gibi yapar
          cat <<EOF | sudo tee -a sys_mount/system/build.prop
          # Efe Elite Dev Touch Configs
          persist.sys.phh.d2tw=true
          ro.vendor.sdk.gesture.d2tw=1
          persist.vendor.qti.input_resampling_rate=120
          view.touch_slop=2
          view.scroll_friction=0.008
          ro.config.hw_quickpoweron=true
          EOF
          
          # --- 2. Dokunmatik Fix Script (Senin Paylaştığın Efsane) ---
          sudo cp services.sh sys_mount/system/bin/gsi-touch-fix.sh
          sudo chmod 755 sys_mount/system/bin/gsi-touch-fix.sh
          
          # --- 3. Init Service (Scripti Sisteme Çivileme) ---
          cat <<EOF | sudo tee sys_mount/system/etc/init/gsi_fixes.rc
          service gsi_fixes /system/bin/sh /system/bin/gsi-touch-fix.sh
              class main
              user root
              group root
              seclabel u:r:magisk:s0
              oneshot
          EOF
          
          # --- 4. Volume Wake (Ses Tuşuyla Anında Uyandırma) ---
          sudo sed -i 's/key 115   VOLUME_UP/key 115   VOLUME_UP           WAKE/g' sys_mount/system/usr/keylayout/Generic.kl
          sudo sed -i 's/key 114   VOLUME_DOWN/key 114   VOLUME_DOWN         WAKE/g' sys_mount/system/usr/keylayout/Generic.kl

          # Temizlik
          sudo umount sys_mount
          img2simg miku_raw.img miku_final.img

      - name: Upload Modified GSI
        uses: actions/upload-artifact@v4
        with:
          name: Miku-GSI-Tikir-Tikir-Edition
          path: miku_final.img
