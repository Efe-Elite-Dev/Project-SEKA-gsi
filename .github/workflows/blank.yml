name: A04s-All-In-One-Builder

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python & GDown
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip android-sdk-libsparse-utils
          # GDown yüklemesi
          pip3 install --upgrade gdown --break-system-packages

      - name: Download Files (Force Mega Download)
        run: |
          # Miku GSI - Hata verirse build'i burada durdur (Fail fast)
          gdown --id 1A8sLEoItqNuoX1LnWJUKokZRPtHter_k -O miku.img --fuzzy
          
          # Vendor
          gdown --id 1S11bA-SEtg0ILETxerkTNblU_361vF7B -O vendor.img --fuzzy
          
          # BOYUT KONTROLÜ - Eğer dosya 100MB'dan küçükse indirilemedi say!
          FILESIZE=$(stat -c%s "miku.img")
          if [ $FILESIZE -lt 100000000 ]; then
            echo "HATA: Dosya hala 2KB! Google Drive engeli aşılamadı."
            exit 1
          fi

      - name: Build ROM
        run: |
          # Sparse dosyasını RAW'a çevir (A04s için en sağlıklısı)
          simg2img miku.img A04s_Miku_AllInOne.img || cp miku.img A04s_Miku_AllInOne.img
          echo "Build başarılı! Gerçek boyutlu dosya hazır."

      - name: Create Miku Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v4.0-A04s-Final"
          name: "A04s Miku ROM - GERÇEK GSI"
          body: |
            ### VocaloidWorld1 - Project SEKA
            - **Geliştirici:** Efe
            - **Yaş:** 13 (22 Şubat'ta 14!)
            - **Durum:** GDown Bypass ile gerçek boyut sağlandı.
          files: A04s_Miku_AllInOne.img
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
