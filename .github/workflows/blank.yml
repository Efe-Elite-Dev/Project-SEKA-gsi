name: GSI Ultimate (XZ Release Edition)

on:
  workflow_dispatch:

jobs:
  mod-gsi:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y android-sdk-libsparse-utils python3-pip xz-utils
          pip3 install gdown --break-system-packages
          sudo ln -sf /usr/bin/android-simg2img /usr/local/bin/simg2img
          sudo ln -sf /usr/bin/android-img2simg /usr/local/bin/img2simg

      - name: Download GSI
        run: gdown --id 1A8sLEoItqNuoX1LnWJUKokZRPtHter_k -O miku.img

      - name: Mount and Inject Mods
        run: |
          simg2img miku.img miku_raw.img || cp miku.img miku_raw.img
          mkdir sys_mount
          sudo mount -o loop miku_raw.img sys_mount
          
          # build.prop ModlarÄ±
          cat <<EOF | sudo tee -a sys_mount/system/build.prop
          persist.sys.phh.d2tw=true
          ro.vendor.sdk.gesture.d2tw=1
          persist.vendor.qti.input_resampling_rate=120
          view.touch_slop=2
          ro.config.hw_quickpoweron=true
          EOF
          
          # Touch Fix Script (Vega.ogg mantÄ±ÄŸÄ±na uygun, her zaman arka planda)
          cat <<EOF | sudo tee sys_mount/system/bin/gsi-touch-fix.sh
          #!/system/bin/sh
          fix() { su -c 'echo check_connection > /sys/class/sec/tsp/cmd && cat /sys/class/sec/tsp/cmd_result';}
          dir="/sys/class/backlight/panel/brightness"
          while true; do
            sleep .6
            new=\$(cat "\$dir")
            [ "\$old" != "\$new" ] && [ "\$new" != "0" ] && fix
            old=\$new
          done
          EOF
          sudo chmod 755 sys_mount/system/bin/gsi-touch-fix.sh
          
          # Init Service
          cat <<EOF | sudo tee sys_mount/system/etc/init/gsi_fixes.rc
          service gsi_fixes /system/bin/sh /system/bin/gsi-touch-fix.sh
              class main
              user root
              group root
              oneshot
          EOF
          
          # Volume Wake
          sudo sed -i 's/key 115   VOLUME_UP/key 115   VOLUME_UP           WAKE/g' sys_mount/system/usr/keylayout/Generic.kl
          sudo sed -i 's/key 114   VOLUME_DOWN/key 114   VOLUME_DOWN         WAKE/g' sys_mount/system/usr/keylayout/Generic.kl

          sudo umount sys_mount
          # Ham imajÄ± sparse yap (daha kÃ¼Ã§Ã¼k olur)
          img2simg miku_raw.img miku_sparse.img

      - name: Compress with XZ (Mermi SÄ±kÄ±ÅŸtÄ±rma)
        run: |
          # -9 en yÃ¼ksek sÄ±kÄ±ÅŸtÄ±rma, -T0 tÃ¼m CPU Ã§ekirdeklerini kullanÄ±r (HÄ±zlÄ±dÄ±r)
          xz -9 -T0 miku_sparse.img
          mv miku_sparse.img.xz miku_final.img.xz

      - name: Create Release and Upload
        uses: ncipollo/release-action@v1
        with:
          artifacts: "miku_final.img.xz"
          tag: "v${{ github.run_number }}-${{ github.sha }}"
          name: "Project-SEKA GSI Build ${{ github.run_number }}"
          body: |
            ### ðŸ…¥ Vocaloid World Special Edition
            - **Touch Fix:** Ekran kapalÄ±yken dokunmatik sorunu Ã§Ã¶zÃ¼ldÃ¼.
            - **D2TW:** Ã‡ift tÄ±kla uyandÄ±rma aktif.
            - **Volume Wake:** Ses tuÅŸlarÄ±yla uyandÄ±rma eklendi.
            - **SÄ±kÄ±ÅŸtÄ±rma:** XZ (YÃ¼ksek OranlÄ±)
            - **Versiyon:** ${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}
