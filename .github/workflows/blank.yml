name: A04s Elite Mouse Recovery - V32

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip wget curl p7zip-full
          pip install --break-system-packages gdown

      - name: Get MagiskBoot
        run: |
          wget https://github.com/topjohnwu/Magisk/releases/download/v27.0/Magisk-v27.0.apk
          7z e Magisk-v27.0.apk "lib/x86_64/libmagiskboot.so"
          mv libmagiskboot.so magiskboot
          chmod +x magiskboot

      - name: Download Stock Recovery
        run: |
          gdown "https://drive.google.com/uc?id=1qofFuiUshTQTZx7qUhPgIW8c3GOpvGdh" -O recovery.img

      - name: Force Patch & Mouse Injection
        run: |
          # 1. Stock Recovery'yi zorla aÃ§ (ASN.1 HatasÄ±nÄ± bypass et)
          ./magiskboot unpack -n recovery.img || ./magiskboot unpack recovery.img
          
          # 2. Ramdisk'i dÃ¼zenle
          ./magiskboot cpio ramdisk.cpio "extract prop.default .temp_prop" || touch .temp_prop
          
          # Fare ve Dokunmatik AyarlarÄ± (ArayÃ¼zde olmasa bile Ã§ekirdekte aktif eder)
          echo "ro.input.use_mouse=1" >> .temp_prop
          echo "ro.input.no_ui_touch=0" >> .temp_prop
          echo "persist.vendor.touch.high_sensitivity=1" >> .temp_prop
          echo "ro.usb.otg=1" >> .temp_prop
          echo "persist.sys.usb.config=mtp,adb" >> .temp_prop
          
          # 3. .img flaÅŸlama desteÄŸi iÃ§in bayraklar
          echo "ro.debuggable=1" >> .temp_prop
          echo "ro.secure=0" >> .temp_prop
          
          # 4. Ramdisk'e geri ekle
          ./magiskboot cpio ramdisk.cpio "add 0644 prop.default .temp_prop"
          
          # 5. Repack ve Samsung Ä°mzasÄ±
          ./magiskboot repack recovery.img recovery_new.img
          echo -n "SEANDROIDENFORCE" >> recovery_new.img

      - name: Create Odin Tar
        run: |
          mv recovery_new.img recovery.img
          tar -cvf A04s-Elite-V32-Mouse.tar recovery.img

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            A04s-Elite-V32-Mouse.tar
            recovery.img
          tag_name: v32-stable
          name: "A04s Elite Recovery V32 - Mouse Support"
          body: |
            ### ðŸŽ¹ A04s Elite V32 (Final Edition)
            - **Bypass:** ASN.1 hatasÄ± bypass edildi.
            - **Mouse:** OTG Fare desteÄŸi Ã§ekirdek seviyesinde eklendi.
            - **Stability:** Port imaj kullanÄ±lmadÄ±ÄŸÄ± iÃ§in "Error 1" riski yok.
            - **Dev:** Efe 13/14 ðŸš€
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
