name: GSI Ultimate (Elite Gaming Edition)

on:
  workflow_dispatch:

jobs:
  mod-gsi:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: System Cleanup & Install Tools
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get update
          sudo apt-get install -y android-sdk-libsparse-utils python3-pip xz-utils e2fsprogs
          pip3 install gdown --break-system-packages
          sudo ln -sf /usr/bin/android-simg2img /usr/local/bin/simg2img
          sudo ln -sf /usr/bin/android-img2simg /usr/local/bin/img2simg

      - name: Download GSI
        run: gdown --id 1A8sLEoItqNuoX1LnWJUKokZRPtHter_k -O miku.img

      - name: Prepare & Resize Image
        run: |
          simg2img miku.img miku_raw.img || mv miku.img miku_raw.img
          e2fsck -f miku_raw.img || true
          # Daha fazla mod ekliyoruz, o yÃ¼zden 200MB yer aÃ§alÄ±m
          resize2fs miku_raw.img $(($(stat -c %s miku_raw.img)/1024/1024 + 200))M

      - name: Mount and Inject Mods
        run: |
          mkdir sys_mount
          sudo mount -o loop,rw miku_raw.img sys_mount
          
          # 1. build.prop - Extreme Performance & UI Tweaks
          cat <<EOF | sudo tee -a sys_mount/system/build.prop
          # --- Project-SEKA Elite Tweaks ---
          persist.sys.phh.d2tw=true
          ro.vendor.sdk.gesture.d2tw=1
          # Dokunmatik Hassasiyeti (Sampling Rate)
          persist.vendor.qti.input_resampling_rate=120
          view.touch_slop=2
          # AkÄ±cÄ±lÄ±k ve FPS (UI Tweaks)
          persist.sys.composition.type=gpu
          debug.cpurenderer.enabled=1
          debug.egl.hw=1
          debug.sf.hw=1
          ro.config.low_ram=false
          # Google Photos SÄ±nÄ±rsÄ±z Depolama Hilesi (Pixel 5 taklidi)
          ro.product.model=Pixel 5
          ro.product.brand=google
          # Ä°nternet HÄ±zlandÄ±rma
          net.tcp.buffersize.wifi=262144,524288,1048576,2097152,4194304
          EOF
          
          # 2. Gaming & Touch Fix Script (GeliÅŸmiÅŸ Versiyon)
          cat <<EOF | sudo tee sys_mount/system/bin/gsi-ultimate-fix.sh
          #!/system/bin/sh
          # Dokunmatik Fix
          while true; do
            sleep 1
            if [ "\$(cat /sys/class/backlight/panel/brightness)" != "0" ]; then
              echo check_connection > /sys/class/sec/tsp/cmd
            fi
            # Arka planda CPU'yu 'Performance' moduna zorla (Oyunlar iÃ§in)
            echo "performance" > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null
          done
          EOF
          sudo chmod 755 sys_mount/system/bin/gsi-ultimate-fix.sh
          
          # 3. Custom Boot Animation (Opsiyonel - EÄŸer sistemde varsa deÄŸiÅŸtirir)
          # Buraya kendi animasyon linkini ekleyebilirsin aga.

          # 4. Debloat (Gereksiz Google servislerini silerek RAM aÃ§ma)
          sudo rm -f sys_mount/system/app/LatinImeGoogle/LatinImeGoogle.apk || true

          sudo umount sys_mount

      - name: Final Compress & Release
        run: |
          img2simg miku_raw.img miku_sparse.img
          xz -3 -T0 miku_sparse.img
          mv miku_sparse.img.xz miku_final.img.xz

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: miku_final.img.xz
          tag_name: "v${{ github.run_number }}-ultimate"
          name: "Project-SEKA GSI ULTIMATE v${{ github.run_number }}"
          body: |
            ### ðŸ…¥ Vocaloid World - ULTIMATE GAMING EDITION
            - **Touch Fix & D2TW:** TÄ±kÄ±r tÄ±kÄ±r Ã§alÄ±ÅŸÄ±yor.
            - **Gaming Mode:** GPU Rendering ve CPU Performance tweaks aktif.
            - **Pixel 5 Spoof:** Google FotoÄŸraflar'da sÄ±nÄ±rsÄ±z depolama!
            - **Network Fix:** Daha stabil Ping ve Wi-Fi hÄ±zÄ±.
            - **UI Fast:** ArayÃ¼z yaÄŸ gibi akÄ±yor (120Hz optimizasyonu).
          token: ${{ secrets.GITHUB_TOKEN }}
